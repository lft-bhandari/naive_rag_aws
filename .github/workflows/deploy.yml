name: Deploy RAG Microservices

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # ── Job 1: Lint & Test ──────────────────────────────────────────────────────
  test:
    name: Lint & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install ruff
        run: pip install ruff==0.6.9

      - name: Lint backend
        run: ruff check backend/ --select E,W,F --ignore E501

      - name: Syntax check
        run: |
          python - <<'PYEOF'
          import ast, pathlib
          files = list(pathlib.Path('backend').glob('**/*.py'))
          for p in files:
              ast.parse(p.read_text())
              print(f'OK: {p}')
          print('Syntax OK')
          PYEOF

  # ── Job 2: Deploy to EC2 ────────────────────────────────────────────────────
  deploy:
    name: Deploy to EC2
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: SSH into EC2 and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          command_timeout: 30m
          script: |
            set -e
            cd /opt/rag-microservices

            echo ">>> Pulling latest code from GitHub..."
            git fetch origin main
            git reset --hard origin/main

            echo ">>> Building and restarting containers..."
            docker compose up -d --build --force-recreate --remove-orphans

            echo ">>> Pruning old images..."
            docker image prune -f

            echo ">>> Container status:"
            docker compose ps

            echo ">>> Deployment complete!"

      - name: Health check
        run: |
          echo "Waiting 30s for services..."
          sleep 30
          STATUS=$(curl -sf -o /dev/null -w "%{http_code}" \
            http://${{ secrets.EC2_PUBLIC_IP }}/health || echo "000")
          echo "Health check status: $STATUS"
          [[ "$STATUS" == "200" ]] || { echo "Health check failed!"; exit 1; }

      - name: Notify success
        if: success()
        run: |
          echo "Deployment succeeded!"
          echo "Commit  : ${{ github.sha }}"
          echo "URL     : http://${{ secrets.EC2_PUBLIC_IP }}/"

      - name: Notify failure
        if: failure()
        run: echo "Deployment FAILED for commit ${{ github.sha }}"